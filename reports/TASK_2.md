# –û—Ç—á–µ—Ç –ø–æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –ö–ï–ô–° 2

## 1. –¢–µ—Å—Ç-–∫–µ–π—Å

**–ê–∫–∫–∞—É–Ω—Ç:** `acc-5`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Ç–∞:**
```json
{
  "ratePerSecond": 2,
  "testCount": 100,
  "processingTimeMillis": 60000
}
```

**–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞:**
```bash
curl -X POST http://localhost:1234/test/run \
  -H "Content-Type: application/json" \
  -d '{
    "serviceName": "id_–∫–æ–º–∞–Ω–¥—ã",
    "token": "token_–∫–æ–º–∞–Ω–¥—ã",
    "ratePerSecond": 2,
    "testCount": 100,
    "processingTimeMillis": 60000
  }'
```

## 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ acc-5

**–î–∞–Ω–Ω—ã–µ –∏–∑ bombardier:**
```json
{
    "serviceName": "cas-m3404-09",
    "accountName": "acc-5",
    "parallelRequests": 5,
    "rateLimitPerSec": 3,
    "price": 30,
    "averageProcessingTime": "PT4.9S"
}
```

**–ê–Ω–∞–ª–∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:**
- –¢–µ—Å—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç **2 RPS**, –∞–∫–∫–∞—É–Ω—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **3 RPS** ‚úÖ (–ª–∏–º–∏—Ç –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω)
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: **4.9 —Å–µ–∫—É–Ω–¥—ã** (–æ—á–µ–Ω—å –¥–æ–ª–≥–æ!)
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: **5** (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
- –û–±—â–µ–µ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞: **60 —Å–µ–∫—É–Ω–¥** (100 –∑–∞–ø—Ä–æ—Å–æ–≤ / 2 RPS = 50 —Å–µ–∫—É–Ω–¥ + –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏)

## 3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

### 3.1. –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–ö–æ–º–∞–Ω–¥—ã Prometheus –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
```prometheus
# –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥
sum(increase(test_duration_count[10m]))

# Success rate (%)
(sum(increase(test_duration_count{testOutcome="SUCCESS"}[10m])) / sum(increase(test_duration_count[10m]))) * 100

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
sum(increase(payment_finished_total{outcome="SUCCESS"}[10m]))

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
sum(increase(payment_finished_total{outcome="FAIL"}[10m]))

# Rate limit –Ω–∞—Ä—É—à–µ–Ω–∏—è –¥–ª—è acc-5
sum(increase(external_sys_duration_count{accountName="acc-5",outcome="rate_limit_breached"}[10m]))

# Parallel requests limit –Ω–∞—Ä—É—à–µ–Ω–∏—è –¥–ª—è acc-5
sum(increase(external_sys_duration_count{accountName="acc-5",outcome="parallel_requests_limit_breached"}[10m]))

# Timeout –æ—à–∏–±–∫–∏ –¥–ª—è acc-5
sum(increase(external_sys_duration_count{accountName="acc-5",outcome="timeout"}[10m]))
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–∞–∑–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:**
- –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: 210
- –£—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: 86 %
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π: 178
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π: 29
- Parallel Request limit –Ω–∞—Ä—É—à–µ–Ω–∏–π: 20
- Rate limit –Ω–∞—Ä—É—à–µ–Ω–∏–π: 0 (—Ç–µ—Å—Ç 2 RPS < –ª–∏–º–∏—Ç 3 RPS)

### 3.2. –°–∫—Ä–∏–Ω—à–æ—Ç—ã –º–µ—Ç—Ä–∏–∫

![grafana_1.png](pics/task_2/first_run/grafana_1.png)
![prometheus_1.png](pics/task_2/first_run/prometheus_1.png)
![prometheus_2.png](pics/task_2/first_run/prometheus_2.png)[–ú–ï–°–¢–û –î–õ–Ø –°–ö–†–ò–ù–®–û–¢–û–í]

### 3.3. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. **Timeout –ø—Ä–æ–±–ª–µ–º—ã**: 
   - –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ 4.9 —Å–µ–∫—É–Ω–¥—ã vs —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ HTTP —Ç–∞–π–º–∞—É—Ç—ã
   - –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–º—É —Ä–∞–∑—Ä—ã–≤—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
   - Default read timeout –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω –¥–ª—è –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

2. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º**:
   - –í—Å–µ–≥–æ 5 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Ç–æ–∫–∞
   - –ü—Ä–∏ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ 4.9—Å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥–∏
   - RPS * processing_time = 2 * 4.9 = 9.8 > 5 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

3. **Connection pool –∏—Å—á–µ—Ä–ø–∞–Ω–∏–µ**:
   - –î–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –∏—Å—á–µ—Ä–ø–∞—Ç—å connection pool
   - Default –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OkHttp –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏

4. **Memory leaks –ø—Ä–∏ –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö**:
   - –î–ª–∏—Ç–µ–ª—å–Ω—ã–µ HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è
   - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** Parallel request limit (5) –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏: 2 RPS √ó 4.9s = 9.8 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

## 4. –ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 4.1. –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: Parallel Request Limit**
```
–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã:
–ù—É–∂–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ = RPS √ó –≤—Ä–µ–º—è_–æ–±—Ä–∞–±–æ—Ç–∫–∏
2 RPS √ó 4.9—Å = 9.8 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

–î–æ—Å—Ç—É–ø–Ω–æ: 5 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ ‚ùå
–ù—É–∂–Ω–æ: 9.8 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
–î–µ—Ñ–∏—Ü–∏—Ç: 4.8 –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è –∫–∞–∫ parallel_requests_limit_breached
```

**–ü—Ä–æ–±–ª–µ–º—ã –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–µ:**
1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞**: –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. **–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ HTTP –≤—ã–∑–æ–≤—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ
3. **–ö–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–π–º–∞—É—Ç—ã**: Default HTTP timeouts –¥–ª—è –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (4.9—Å)
4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ queue management**: –ù–µ—Ç –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 4.2. –ò—Ç–µ—Ä–∞—Ü–∏—è 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Semaphore –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞

**–ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏:**
- –î–æ–±–∞–≤–∏–ª–∏ `Semaphore(parallelRequests)` –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ 5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –†–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —á–µ—Ä–µ–∑ `kotlin.concurrent.thread`
- –£–≤–µ–ª–∏—á–∏–ª–∏ HTTP —Ç–∞–π–º–∞—É—Ç—ã –¥–æ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è 4.9—Å –æ–ø–µ—Ä–∞—Ü–∏–π

**–ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
```kotlin
private val parallelRequestSemaphore = Semaphore(parallelRequests)

override fun performPaymentAsync(paymentId: UUID, amount: Int, paymentStartedAt: Long, deadline: Long) {
    // ... submission logic
    thread {
        executeWithSemaphore(paymentId, transactionId, amount)
    }
}

private fun executeWithSemaphore(paymentId: UUID, transactionId: UUID, amount: Int) {
    try {
        parallelRequestSemaphore.acquire() // –ñ–¥–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç
        executePaymentRequest(paymentId, transactionId, amount)
    } finally {
        parallelRequestSemaphore.release() // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Å–ª–æ—Ç
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Success rate —É—Ö—É–¥—à–∏–ª—Å—è –¥–æ ~63% - –ø–æ—è–≤–∏–ª–∏—Å—å rate limit –Ω–∞—Ä—É—à–µ–Ω–∏—è!

### 4.3. –ò—Ç–µ—Ä–∞—Ü–∏—è 2: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Semaphore + Rate Limiting

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
Semaphore —Ä–µ—à–∏–ª parallel limit, –Ω–æ —É—Å–∫–æ—Ä–∏–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤, —á—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –∫ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—é 3 RPS –ª–∏–º–∏—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞.

**–ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏:**
- –î–æ–±–∞–≤–∏–ª–∏ `SlidingWindowRateLimiter` –∏–∑ –ö–ï–ô–° 1 –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è 3 RPS
- –†–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ infinite retry –¥–ª—è rate limiting (–∫–∞–∫ –≤ –ö–ï–ô–° 1)
- –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–ª–∏ –æ–±–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: semaphore + rate limiter

**–§–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥:**
```kotlin
private val parallelRequestSemaphore = Semaphore(parallelRequests)
private val rateLimiter = SlidingWindowRateLimiter(
    rate = (rateLimitPerSec * 1.1).toLong(), // 3.3 RPS —Å –±—É—Ñ–µ—Ä–æ–º
    window = Duration.ofSeconds(1)
)

private fun executeWithSemaphore(paymentId: UUID, transactionId: UUID, amount: Int) {
    try {
        parallelRequestSemaphore.acquire() // –ö–æ–Ω—Ç—Ä–æ–ª—å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞
        
        // Infinite retry –¥–ª—è rate limiting (–∫–∞–∫ –≤ –ö–ï–ô–° 1)
        var currentAttempt = 1
        while (!rateLimiter.tick()) {
            Thread.sleep(5)
            currentAttempt++
        }
        
        executePaymentRequest(paymentId, transactionId, amount)
    } finally {
        parallelRequestSemaphore.release()
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Success rate –¥–æ—Å—Ç–∏–≥ **100%** - –æ–±–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —É—á—Ç–µ–Ω—ã!

### 4.4. –§–∏–ª–æ—Å–æ—Ñ–∏—è —Ä–µ—à–µ–Ω–∏—è

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**
- **–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ**: Semaphore (–ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º) + RateLimiter (–ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å)
- **Graceful queuing**: –ó–∞–ø—Ä–æ—Å—ã –∂–¥—É—Ç –≤–º–µ—Å—Ç–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ threading
- **Infinite patience**: –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–∫–ª–æ–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å—ã, —Ç–æ–ª—å–∫–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º

---

## 5. –§–∏–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### 5.1. –û–ø–∏—Å–∞–Ω–∏–µ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è:**
–†–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ **"–≥–∏–±—Ä–∏–¥–Ω—É—é —Å–∏—Å—Ç–µ–º—É –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π"**, –∫–æ—Ç–æ—Ä–∞—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –¥–≤–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –ª–∏–º–∏—Ç–∞: –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º (5 –∑–∞–ø—Ä–æ—Å–æ–≤) –∏ –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å (3 RPS).

**1. –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π:**

**–ß—Ç–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- **Semaphore(5)**: –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–æ parallelRequests
- **SlidingWindowRateLimiter(3.3)**: –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤ —Å +10% –±—É—Ñ–µ—Ä–æ–º
- **Threading**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –†–µ—à–∞–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–±–ª–µ–º—É: 2 RPS √ó 4.9s = 9.8 ‚Üí –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 5 + –æ—á–µ—Ä–µ–¥—å
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç parallel_requests_limit_breached –æ—à–∏–±–∫–∏
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ–±–ª—é–¥–µ–Ω–∏–µ rate limiting —á–µ—Ä–µ–∑ infinite retry

```kotlin
private val parallelRequestSemaphore = Semaphore(parallelRequests) // –ö–æ–Ω—Ç—Ä–æ–ª—å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞
private val rateLimiter = SlidingWindowRateLimiter(
    rate = (rateLimitPerSec * 1.1).toLong(), // 3.3 RPS —Å –±—É—Ñ–µ—Ä–æ–º
    window = Duration.ofSeconds(1)
)

// –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
private fun executeWithSemaphore(paymentId: UUID, transactionId: UUID, amount: Int) {
    try {
        parallelRequestSemaphore.acquire() // –ñ–¥–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç (–¥–æ 5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
        
        var currentAttempt = 1
        while (!rateLimiter.tick()) { // –ñ–¥–µ–º rate limit —Å–ª–æ—Ç (3 RPS)
            Thread.sleep(5) // Micro-delay
            currentAttempt++
        }
        
        executePaymentRequest(paymentId, transactionId, amount) // –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û–ï –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    } finally {
        parallelRequestSemaphore.release() // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Å–ª–æ—Ç –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ
    }
}
```

**2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HTTP Client –¥–ª—è –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:**

**–ß—Ç–æ –º—ã –∏–∑–º–µ–Ω–∏–ª–∏:**
- **Read Timeout**: 30 —Å–µ–∫—É–Ω–¥ (–±—ã–ª–æ default ~30s) –¥–ª—è —É—á–µ—Ç–∞ 4.9—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **Connect Timeout**: 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **Write Timeout**: 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö

```kotlin
private val client = OkHttpClient.Builder()
    .connectTimeout(10, TimeUnit.SECONDS)  // –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
    .readTimeout(30, TimeUnit.SECONDS)     // –î–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ 4.9—Å
    .writeTimeout(10, TimeUnit.SECONDS)
    .build()
```

### 5.2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

**–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ —Ä–µ—à–µ–Ω–∏—è:**
- **–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**: Parallel limit breached –ø—Ä–∏ 9.8 –Ω—É–∂–Ω—ã—Ö vs 5 –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
- **–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**: –û—á–µ—Ä–µ–¥—å –æ–∂–∏–¥–∞–Ω–∏—è + rate limiting = 100% success rate

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π:**
1. **2 RPS –Ω–∞–≥—Ä—É–∑–∫–∞** –ø–æ—Å—Ç—É–ø–∞–µ—Ç –≤ —Å–∏—Å—Ç–µ–º—É
2. **Thread pool** —Å–æ–∑–¥–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞  
3. **Semaphore(5)** –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
4. **–ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** –∂–¥—É—Ç –≤ –æ—á–µ—Ä–µ–¥–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Å–ª–æ—Ç–∞
5. **RateLimiter(3.3)** –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —á–∞—Å—Ç–æ—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏
6. **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã, –Ω–∏ –æ–¥–∏–Ω –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
- **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º**: –ú–∞–∫—Å–∏–º—É–º 5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **Throughput**: 100% –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ (–±—ã–ª–æ 86%)
- **Latency**: +–æ–∂–∏–¥–∞–Ω–∏–µ –¥–ª—è –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø—Ä–∏–µ–º–ª–µ–º–æ)
- **Resource usage**: –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

### 5.3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è

**–ö–æ–º–∞–Ω–¥—ã Prometheus –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
```prometheus
# Success rate (%)
(sum(increase(test_duration_count{testOutcome="SUCCESS"}[10m])) / sum(increase(test_duration_count[10m]))) * 100

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π  
sum(increase(payment_finished_total{outcome="SUCCESS"}[10m]))

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
sum(increase(payment_finished_total{outcome="FAIL"}[10m]))

# Parallel requests limit –Ω–∞—Ä—É—à–µ–Ω–∏—è
sum(increase(external_sys_duration_count{accountName="acc-5",outcome="parallel_requests_limit_breached"}[10m]))

# Rate limit –Ω–∞—Ä—É—à–µ–Ω–∏—è
sum(increase(external_sys_duration_count{accountName="acc-5",outcome="rate_limit_breached"}[10m]))
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- **Success rate: 100%** üéØ
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ parallel request limit –Ω–∞—Ä—É—à–µ–Ω–∏–π: 0
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ rate limit –Ω–∞—Ä—É—à–µ–Ω–∏–π: 0
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –æ—á–µ—Ä–µ–¥–µ–π

### 5.4. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|----------------|-------------------|-----------|
| **Success Rate** | 86% | **100%**          | **+14%** |
| –£—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π | 178 | **207**           | –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã |
| –ù–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π | 29 | **0**             | -100% |
| Parallel request limit –Ω–∞—Ä—É—à–µ–Ω–∏–π | 20 | **0**             | -100% |
| Rate limit –Ω–∞—Ä—É—à–µ–Ω–∏–π | 0 | **0**             | –°—Ç–∞–±–∏–ª—å–Ω–æ |

**–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
1. **Dual-level throttling**: Semaphore + RateLimiter –¥–ª—è –¥–≤—É—Ö —Ç–∏–ø–æ–≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
2. **Graceful queuing**: –ó–∞–ø—Ä–æ—Å—ã –∂–¥—É—Ç –≤–º–µ—Å—Ç–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
3. **Asynchronous processing**: Threading –¥–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
4. **Long operation support**: –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è 4.9—Å –æ–ø–µ—Ä–∞—Ü–∏–π

### –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
![grafana_success_local.png](pics/task_2/grafana_success_local.png)

### –£–¥–∞–ª–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
![grafana_success_external.png](pics/task_2/grafana_success_external.png)
---