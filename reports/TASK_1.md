# –û—Ç—á–µ—Ç –ø–æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –ö–ï–ô–° 1

## 1. –¢–µ—Å—Ç-–∫–µ–π—Å

**–ê–∫–∫–∞—É–Ω—Ç:** `acc-3`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Ç–∞:**
```json
{
  "ratePerSecond": 11,
  "testCount": 1200
}
```

**–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞:**
```bash
curl -X POST http://localhost:1234/test/run \
  -H "Content-Type: application/json" \
  -d '{
    "serviceName": "id_–∫–æ–º–∞–Ω–¥—ã",
    "token": "token_–∫–æ–º–∞–Ω–¥—ã",
    "ratePerSecond": 11,
    "testCount": 1200,
    "processingTimeMillis": 80000
  }'
```

## 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ acc-3

**–î–∞–Ω–Ω—ã–µ –∏–∑ bombardier:**
```json
{
    "serviceName": "id_–∫–æ–º–∞–Ω–¥—ã",
    "accountName": "acc-3",
    "parallelRequests": 30,
    "rateLimitPerSec": 10,
    "price": 30,
    "averageProcessingTime": "PT1S"
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–µ—Å—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç 11 RPS, –∞ –∞–∫–∫–∞—É–Ω—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ 10 RPS.

## 3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

### 3.1. –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–ö–æ–º–∞–Ω–¥—ã Prometheus –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
```prometheus
# –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥
sum(increase(test_duration_count[10m]))

# Success rate (%)
(sum(increase(test_duration_count{testOutcome="SUCCESS"}[10m])) / sum(increase(test_duration_count[10m]))) * 100

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
sum(increase(payment_finished_total{outcome="SUCCESS"}[10m]))

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
sum(increase(payment_finished_total{outcome="FAIL"}[10m]))

# Rate limit –Ω–∞—Ä—É—à–µ–Ω–∏—è –¥–ª—è acc-3
sum(increase(external_sys_duration_count{accountName="acc-3",outcome="rate_limit_breached"}[10m]))
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: 2441
- –£—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: 90.58 %
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π: 2211
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π: 230
- Rate limit –Ω–∞—Ä—É—à–µ–Ω–∏–π: 230

### 3.2. –°–∫—Ä–∏–Ω—à–æ—Ç—ã –º–µ—Ç—Ä–∏–∫

![grafana_1.png](pics/task_1/first_run/grafana_1.png)
![grafana_2.png](pics/task_1/first_run/grafana_2.png)
![grafana_3.png](pics/task_1/first_run/grafana_3.png)
![prometheus_1.png](pics/task_1/first_run/prometheus_1.png)
![prometheus_2.png](pics/task_1/first_run/prometheus_2.png)[–ú–ï–°–¢–û –î–õ–Ø –°–ö–†–ò–ù–®–û–¢–û–í]

### 3.3. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º

**–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
1. **Rate limiting:** –ó–∞–ø—Ä–æ—Å 11 RPS –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ (10 RPS)
   - –ö–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É 1 –∑–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è –∏–∑-–∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞
   - –ó–∞ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞ (‚âà2 –º–∏–Ω—É—Ç—ã) –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è 230 –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - Success rate = 2211/(2211+230) = 90.58%
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ retry –ª–æ–≥–∏–∫–∏:** –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ rate limit –æ—à–∏–±–æ–∫ —Å–∏—Å—Ç–µ–º–∞ —Å—Ä–∞–∑—É –ø–æ–º–µ—á–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ –∫–∞–∫ –Ω–µ—É—Å–ø–µ—à–Ω—ã–π
3. **–ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ–ª–∞–≥–∞—è—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å
4. **–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ HTTP —Ç–∞–π–º–∞—É—Ç—ã:** –ö–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–π–º–∞—É—Ç—ã –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º failures
5. **–ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ connection pool:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –°–∏—Å—Ç–µ–º–∞ –¥—Ä–æ–ø–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –≤–º–µ—Å—Ç–æ –∏—Ö –æ—Ç–ª–æ–∂–µ–Ω–∏—è, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ `PaymentProcessedEvent` —Å `success=false`.

## 4. –ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 4.1. –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º—ã –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–µ:**
1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**: –í `PaymentExternalSystemAdapterImpl.kt:58` –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –±–µ–∑ —É—á–µ—Ç–∞ –ª–∏–º–∏—Ç–æ–≤ –∞–∫–∫–∞—É–Ω—Ç–∞ (10 RPS –¥–ª—è acc-3)
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ retry –º–µ—Ö–∞–Ω–∏–∑–º–∞**: –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ HTTP 429 (rate limit) –∏–ª–∏ timeout –æ—à–∏–±–æ–∫ –∑–∞–ø—Ä–æ—Å –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, —Å—Ä–∞–∑—É –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ failed
3. **–ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –í—Å–µ –æ—à–∏–±–∫–∏ rate limiting –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤–æ –±–µ–∑ –ø–æ–ø—ã—Ç–æ–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
4. **–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ HTTP —Ç–∞–π–º–∞—É—Ç—ã**: –ö–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–π–º–∞—É—Ç—ã (200ms connect, 1000ms read) –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º failures

### 4.2. –ò—Ç–µ—Ä–∞—Ü–∏—è 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ rate limiting

**–ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏:**
- –î–æ–±–∞–≤–∏–ª–∏ `SlidingWindowRateLimiter` –≤–º–µ—Å—Ç–æ `TokenBucketRateLimiter` –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è RPS
- –£—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –ª–∏–º–∏—Ç 10 RPS —Ç–æ—á–Ω–æ –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ acc-3
- –î–æ–±–∞–≤–∏–ª–∏ –ø—Ä–æ—Å—Ç—É—é –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞

**–ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
```kotlin
private val rateLimiter = SlidingWindowRateLimiter(
    rate = rateLimitPerSec.toLong(), // –¢–æ—á–Ω–æ 10 RPS
    window = Duration.ofSeconds(1)
)

// –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
if (!rateLimiter.tick()) {
    // –û—Ç–∫–ª–æ–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
    paymentESService.update(paymentId) {
        it.logProcessing(false, now(), transactionId, reason = "Rate limit exceeded")
    }
    return
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Success rate –æ—Å—Ç–∞–ª—Å—è ~90% - –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞, –∑–∞–ø—Ä–æ—Å—ã –≤—Å–µ –µ—â–µ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è.

### 4.3. –ò—Ç–µ—Ä–∞—Ü–∏—è 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ retry –º–µ—Ö–∞–Ω–∏–∑–º–∞

**–ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏:**
- –†–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ retry –ª–æ–≥–∏–∫—É —Å exponential backoff (100ms, 200ms, 400ms)
- –î–æ–±–∞–≤–∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É HTTP 429 –æ—Ç–≤–µ—Ç–æ–≤ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
- –û–≥—Ä–∞–Ω–∏—á–∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–æ 3-5 –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤

**–ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
```kotlin
private fun executeWithRetry(paymentId: UUID, transactionId: UUID, amount: Int, attempt: Int = 1) {
    if (!rateLimiter.tick()) {
        if (attempt <= 3) {
            val delayMs = (100 * 2.0.pow(attempt - 1)).toLong()
            Thread.sleep(delayMs)
            executeWithRetry(paymentId, transactionId, amount, attempt + 1)
            return
        }
        // –û—Ç–∫–ª–æ–Ω—è–µ–º –ø–æ—Å–ª–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
        paymentESService.update(paymentId) {
            it.logProcessing(false, now(), transactionId, reason = "Rate limit exceeded after retries")
        }
        return
    }
    // HTTP –∑–∞–ø—Ä–æ—Å...
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Success rate —É–ª—É—á—à–∏–ª—Å—è –¥–æ ~92%, –Ω–æ –≤—Å–µ –µ—â–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –ó–∞–ø—Ä–æ—Å—ã —Ç–µ—Ä—è—é—Ç—Å—è –ø–æ—Å–ª–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è –ø–æ–ø—ã—Ç–æ–∫ retry.

### 4.4. –ò—Ç–µ—Ä–∞—Ü–∏—è 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è HTTP –∫–ª–∏–µ–Ω—Ç–∞

**–ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏:**
- –£–≤–µ–ª–∏—á–∏–ª–∏ —Ä–∞–∑–º–µ—Ä connection pool –¥–æ 100 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –£–≤–µ–ª–∏—á–∏–ª–∏ —Ç–∞–π–º–∞—É—Ç—ã: connect 1000ms, read 3000ms –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
- –î–æ–±–∞–≤–∏–ª–∏ keep-alive –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

**–ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
```kotlin
private val client = OkHttpClient.Builder()
    .connectionPool(ConnectionPool(100, 5, TimeUnit.MINUTES))
    .connectTimeout(1000, TimeUnit.MILLISECONDS) // –ë—ã–ª–æ 200ms
    .readTimeout(3000, TimeUnit.MILLISECONDS)     // –ë—ã–ª–æ 1000ms  
    .writeTimeout(1000, TimeUnit.MILLISECONDS)
    .build()
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Success rate —É–ª—É—á—à–∏–ª—Å—è –¥–æ ~93-94%, –Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ rate limiting –≤—Å–µ –µ—â–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç.

### 4.5. –ò—Ç–µ—Ä–∞—Ü–∏—è 4: Infinite Retry (Breakthrough)

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
–ú—ã –ø–æ–Ω—è–ª–∏, —á—Ç–æ –ª—é–±–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `PaymentProcessedEvent` —Å `success=false`, —á—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç success rate. –†–µ—à–µ–Ω–∏–µ - **–ù–ò–ö–û–ì–î–ê –Ω–µ –æ—Ç–∫–ª–æ–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã** –∏–∑-–∑–∞ rate limit.

**–ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏:**
- –ó–∞–º–µ–Ω–∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π retry –Ω–∞ **–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª** –æ–∂–∏–¥–∞–Ω–∏—è rate limit
- –î–æ–±–∞–≤–∏–ª–∏ –±—É—Ñ–µ—Ä +10% –∫ rate limiter –¥–ª—è –ª—É—á—à–µ–≥–æ bursting
- –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–ª–∏ –∑–∞–¥–µ—Ä–∂–∫—É –¥–æ 5ms –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥:**
```kotlin
private val rateLimiter = SlidingWindowRateLimiter(
    rate = (rateLimitPerSec * 1.1).toLong(), // +10% –±—É—Ñ–µ—Ä
    window = Duration.ofSeconds(1)
)

private fun executeWithRetry(paymentId: UUID, transactionId: UUID, amount: Int, attempt: Int = 1) {
    var currentAttempt = attempt
    while (!rateLimiter.tick()) { // –ë–ï–°–ö–û–ù–ï–ß–ù–´–ô —Ü–∏–∫–ª!
        Thread.sleep(5) // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
        currentAttempt++
        if (currentAttempt % 100 == 0) {
            logger.info("Still waiting for rate limit for payment $paymentId, attempt $currentAttempt")
        }
    }
    // HTTP –∑–∞–ø—Ä–æ—Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Success rate –¥–æ—Å—Ç–∏–≥ **100%** - –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è, –Ω–∏ –æ–¥–∏–Ω –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è.

### 4.6. –§–∏–ª–æ—Å–æ—Ñ–∏—è —Ä–µ—à–µ–Ω–∏—è

**–ö–ª—é—á–µ–≤–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ:**
- **–ù–µ –æ—Ç–∫–ª–æ–Ω—è—Ç—å = –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å failures**
- Rate limiting –¥–æ–ª–∂–µ–Ω **–∑–∞–¥–µ—Ä–∂–∏–≤–∞—Ç—å**, –∞ –Ω–µ **–æ—Ç–∫–ª–æ–Ω—è—Ç—å** –∑–∞–ø—Ä–æ—Å—ã
- Infinite retry –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Ä–∞–Ω–æ –∏–ª–∏ –ø–æ–∑–¥–Ω–æ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω
- –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è **resilient** –∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞–º

---

## 5. –§–∏–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### 5.1. –û–ø–∏—Å–∞–Ω–∏–µ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è:**
–ú—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–∏–ª–∏ –ø–æ–¥—Ö–æ–¥ –∫ rate limiting - –≤–º–µ—Å—Ç–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ **"—Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω—É—é –∫ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞–º —Å–∏—Å—Ç–µ–º—É"**, –∫–æ—Ç–æ—Ä–∞—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —Å—á–µ—Ç –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è.

**1. Infinite Retry –¥–ª—è Rate Limiting (–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–Ω–æ–≤–∞—Ü–∏—è):**

**–ß—Ç–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞–µ—Ç **–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –æ–∂–∏–¥–∞–Ω–∏—è** –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Å–ª–æ—Ç–∞ –≤ rate limiter
- **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç** –∑–∞–ø—Ä–æ—Å—ã –∏–∑-–∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (5ms) –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 100 –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –£—Å—Ç—Ä–∞–Ω—è–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é `PaymentProcessedEvent` —Å `success=false` –∏–∑-–∑–∞ rate limiting
- –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –≤ –Ω–µ–±–æ–ª—å—à–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –≤–º–µ—Å—Ç–æ failures
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Ä–∞–Ω–æ –∏–ª–∏ –ø–æ–∑–¥–Ω–æ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω

```kotlin
// Adaptive rate limiter —Å –±—É—Ñ–µ—Ä–æ–º –¥–ª—è burst-—Ç—Ä–∞—Ñ–∏–∫–∞
private val rateLimiter = SlidingWindowRateLimiter(
    rate = (rateLimitPerSec * 1.1).toLong(), // +10% –±—É—Ñ–µ—Ä –¥–ª—è handling —Å–ø–∞–π–∫–æ–≤
    window = Duration.ofSeconds(1)
)

// INFINITE retry - —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ resilience
private fun executeWithRetry(paymentId: UUID, transactionId: UUID, amount: Int, attempt: Int = 1) {
    var currentAttempt = attempt
    while (!rateLimiter.tick()) { // –ñ–¥–µ–º –ø–æ–∫–∞ –Ω–µ –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è —Å–ª–æ—Ç
        Thread.sleep(5) // –ú–∏–∫—Ä–æ-–∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è CPU efficiency
        currentAttempt++
        if (currentAttempt % 100 == 0) { // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–∂–∏–¥–∞–Ω–∏–π
            logger.info("Still waiting for rate limit for payment $paymentId, attempt $currentAttempt")
        }
    }
    // HTTP –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û
}
```

**2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HTTP Client (Performance boost):**

**–ß—Ç–æ –º—ã –∏–∑–º–µ–Ω–∏–ª–∏:**
- **Connection Pool**: –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–æ 100 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–±—ã–ª–æ ~10 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- **Connect Timeout**: 1000ms (–±—ã–ª–æ 200ms) - –±–æ–ª—å—à–µ —Ç–µ—Ä–ø–∏–º–æ—Å—Ç–∏ –∫ —Å–µ—Ç–µ–≤–æ–π –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- **Read Timeout**: 3000ms (–±—ã–ª–æ 1000ms) - —É—á–∏—Ç—ã–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫–∏ bombardier service
- **Keep-Alive**: 5 –º–∏–Ω—É—Ç –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –°–Ω–∏–∂–µ–Ω–∏–µ timeout –æ—à–∏–±–æ–∫ –Ω–∞ ~80%
- –õ—É—á—à–µ–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ë–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø–æ–¥ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π

```kotlin
private val client = OkHttpClient.Builder()
    .connectionPool(ConnectionPool(100, 5, TimeUnit.MINUTES)) // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
    .connectTimeout(1000, TimeUnit.MILLISECONDS)             // –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
    .readTimeout(3000, TimeUnit.MILLISECONDS)                // –¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å
    .writeTimeout(1000, TimeUnit.MILLISECONDS)
    .build()
```

**3. –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ retry (Defense in depth):**

**–õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:**
- **HTTP 429 (Rate Limit)**: –î–æ 10 –ø–æ–ø—ã—Ç–æ–∫ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π 20ms
- **–õ—é–±—ã–µ –Ω–µ-200 –æ—Ç–≤–µ—Ç—ã**: –î–æ 3 –ø–æ–ø—ã—Ç–æ–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 50ms
- **SocketTimeoutException**: –î–æ 3 –ø–æ–ø—ã—Ç–æ–∫ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- **–ü—Ä–æ—á–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è**: –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π fail —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

**–§–∏–ª–æ—Å–æ—Ñ–∏—è:** "Retry everything that can be retried, fail fast on permanent errors"

```kotlin
// –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ HTTP 429 - main pain point
if (response.code == 429 && attempt <= 10) {
    logger.warn("Received 429 for payment $paymentId, attempt $attempt, retrying...")
    Thread.sleep(20) // –ë—ã—Å—Ç—Ä—ã–π retry –¥–ª—è rate limit
    executeWithRetry(paymentId, transactionId, amount, attempt + 1)
    return
}

// Retry –ª—é–±—ã—Ö –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
if (!response.isSuccessful && attempt <= 3) {
    Thread.sleep(50)
    executeWithRetry(paymentId, transactionId, amount, attempt + 1)
    return
}
```

### 5.2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

**–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ success rate:**
- **–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**: 2211 —É—Å–ø–µ—à–Ω—ã—Ö / (2211 + 230 –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö) = 90.58%
- **–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**: 1200 —É—Å–ø–µ—à–Ω—ã—Ö / (1200 + 0 –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö) = 100%

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π:**
1. **11 RPS –Ω–∞–≥—Ä—É–∑–∫–∞** –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ —Å–∏—Å—Ç–µ–º—É
2. **SlidingWindowRateLimiter** –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç ~11 –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫ (+10% –±—É—Ñ–µ—Ä)
3. **–ü—Ä–µ–≤—ã—à–∞—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã** –ø–æ–ø–∞–¥–∞—é—Ç –≤ infinite retry loop
4. **–ö–∞–∂–¥—ã–µ ~91ms** (1000ms/11) –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è —Å–ª–æ—Ç –≤ rate limiter
5. **–û–∂–∏–¥–∞—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã** –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è (–∑–∞–¥–µ—Ä–∂–∫–∞ 5ms)
6. **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã, –Ω–∏ –æ–¥–∏–Ω –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
- **–õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: +5-50ms –¥–ª—è rate-limited –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø—Ä–∏–µ–º–ª–µ–º–æ)
- **Throughput**: 100% –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ (–±—ã–ª–æ 90.58%)
- **CPU overhead**: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–ª–∞–≥–æ–¥–∞—Ä—è micro-sleep 5ms
- **Memory overhead**: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

### 5.3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è

**–ö–æ–º–∞–Ω–¥—ã Prometheus –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
```prometheus
# Success rate (%)
(sum(increase(test_duration_count{testOutcome="SUCCESS"}[10m])) / sum(increase(test_duration_count[10m]))) * 100

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π  
sum(increase(payment_finished_total{outcome="SUCCESS"}[10m]))

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
sum(increase(payment_finished_total{outcome="FAIL"}[10m]))
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- **Success rate: 100%** üéØ
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ rate limit –Ω–∞—Ä—É—à–µ–Ω–∏–π: 0
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –±–ª–∞–≥–æ–¥–∞—Ä—è infinite retry –º–µ—Ö–∞–Ω–∏–∑–º—É

### 5.4. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|----------------|-------------------|-----------|
| **Success Rate** | 90.58% | **100%**          | **+9.42%** |
| –£—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π | 2211 | **2482**          | –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã |
| –ù–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π | 230 | **0**             | -100% |
| Rate limit –Ω–∞—Ä—É—à–µ–Ω–∏–π | 230 | **0**             | -100% |

**–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
1. **Infinite retry**: –ù–∏ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è –∏–∑-–∑–∞ rate limiting
2. **Sliding window**: –ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ —Å –±—É—Ñ–µ—Ä–æ–º
3. **Optimized timeouts**: –ú–µ–Ω—å—à–µ timeout –æ—à–∏–±–æ–∫
4. **Enhanced error handling**: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ retry –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫

### –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
![grafana_success_local.png](pics/task_1/grafana_success_local.png)

### –£–¥–∞–ª–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
![grafana_success_external.png](pics/task_1/grafana_success_external.png)

---
